From 7c67f0b6df28f7e0443260eee32feb566c1fb34d Mon Sep 17 00:00:00 2001
From: ElXreno <elxreno@gmail.com>
Date: Thu, 2 Jan 2020 12:06:05 +0300
Subject: [PATCH] Unbundled json-parser

---
 CMakeLists.txt                      | 16 ++++------------
 src/engine/client/http.cpp          |  2 +-
 src/engine/client/serverbrowser.cpp |  2 +-
 src/engine/client/serverbrowser.h   |  2 +-
 src/engine/client/updater.cpp       |  2 +-
 src/engine/shared/json.h            |  2 +-
 6 files changed, 9 insertions(+), 17 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 50467b87c..49580f15c 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -302,6 +302,7 @@ if(DOWNLOAD_GTEST)
 endif()
 find_package(GLEW)
 find_package(GTest)
+pkg_check_modules(JSONPARSER REQUIRED json-parser)
 if(MYSQL)
   find_package(MySQL)
 else()
@@ -364,6 +365,7 @@ if(DOWNLOAD_GTEST)
 endif()
 show_dependency_status("Glew" GLEW)
 show_dependency_status("GTest" GTEST)
+show_dependency_status("json-parser" JSONPARSER)
 if(TARGET_OS AND TARGET_OS STREQUAL "mac")
   show_dependency_status("Hdiutil" HDIUTIL)
 endif()
@@ -508,17 +510,6 @@ if(NOT(GTEST_FOUND) AND DOWNLOAD_GTEST)
   endif()
 endif()
 
-########################################################################
-# DEPENDENCY COMPILATION
-########################################################################
-
-# Static dependencies
-set_glob(DEP_JSON_SRC GLOB src/engine/external/json-parser json.c json.h)
-add_library(json EXCLUDE_FROM_ALL OBJECT ${DEP_JSON_SRC})
-
-list(APPEND TARGETS_DEP json)
-set(DEP_JSON $<TARGET_OBJECTS:json>)
-
 ########################################################################
 # COPY DATA AND DLLS
 ########################################################################
@@ -746,11 +737,12 @@ set(GAME_GENERATED_SHARED
   src/game/generated/protocol.h
 )
 
-set(DEPS ${DEP_JSON} ${ZLIB_DEP})
+set(DEPS ${ZLIB_DEP})
 
 # Libraries
 set(LIBS
   ${CRYPTO_LIBRARIES}
+  ${JSONPARSER_LIBRARIES}
   ${WEBSOCKETS_LIBRARIES}
   ${ZLIB_LIBRARIES}
   ${PLATFORM_LIBS}
diff --git a/src/engine/client/http.cpp b/src/engine/client/http.cpp
index a1ed50311..a73d4ed3c 100644
--- a/src/engine/client/http.cpp
+++ b/src/engine/client/http.cpp
@@ -2,7 +2,7 @@
 
 #include <base/system.h>
 #include <engine/engine.h>
-#include <engine/external/json-parser/json.h>
+#include <json-parser/json.h>
 #include <engine/shared/config.h>
 #include <engine/storage.h>
 #include <game/version.h>
diff --git a/src/engine/client/serverbrowser.cpp b/src/engine/client/serverbrowser.cpp
index 1bc41849b..a639e7591 100644
--- a/src/engine/client/serverbrowser.cpp
+++ b/src/engine/client/serverbrowser.cpp
@@ -20,7 +20,7 @@
 
 #include <mastersrv/mastersrv.h>
 
-#include <engine/external/json-parser/json.h>
+#include <json-parser/json.h>
 
 #include "serverbrowser.h"
 class SortWrap
diff --git a/src/engine/client/serverbrowser.h b/src/engine/client/serverbrowser.h
index 282d20208..bb27ff1f1 100644
--- a/src/engine/client/serverbrowser.h
+++ b/src/engine/client/serverbrowser.h
@@ -5,7 +5,7 @@
 
 #include <engine/serverbrowser.h>
 #include <engine/shared/memheap.h>
-#include <engine/external/json-parser/json.h>
+#include <json-parser/json.h>
 
 class CServerBrowser : public IServerBrowser
 {
diff --git a/src/engine/client/updater.cpp b/src/engine/client/updater.cpp
index e2596b72f..6c169f697 100644
--- a/src/engine/client/updater.cpp
+++ b/src/engine/client/updater.cpp
@@ -3,7 +3,7 @@
 #include <engine/engine.h>
 #include <engine/storage.h>
 #include <engine/client.h>
-#include <engine/external/json-parser/json.h>
+#include <json-parser/json.h>
 #include <engine/shared/json.h>
 #include <game/version.h>
 
diff --git a/src/engine/shared/json.h b/src/engine/shared/json.h
index 9b5af36c5..62d245615 100644
--- a/src/engine/shared/json.h
+++ b/src/engine/shared/json.h
@@ -1,7 +1,7 @@
 #ifndef ENGINE_SHARED_JSON_H
 #define ENGINE_SHARED_JSON_H
 
-#include <engine/external/json-parser/json.h>
+#include <json-parser/json.h>
 
 const struct _json_value *json_object_get (const json_value * object, const char * index);
 const struct _json_value *json_array_get (const json_value * array, int index);
-- 
2.24.1

